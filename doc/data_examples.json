{
  "notes": [
    {
      "projectId": "xforce",
      "id": "SuspiciousClients"
    },
    {
      "projectId": "xforce",
      "id": "SuspiciousServerIPs"
    },
    {
      "projectId": "certificate-manager",
      "id": "Certificates"
    },
    {
      "projectId": "vulnerability-advisor",
      "id": "ImageVulnerabilities"
    },
    {
      "projectId": "vulnerability-advisor",
      "id": "ContainerVulnerabilities"
    },
    {
      "projectId": "xforce",
      "id": "MaliciousServerIPCount"
    },
    {
      "projectId": "xforce",
      "id": "SuspiciousServerIPCount"
    }
  ],
  "occurrences": [
    {
      "docType": "latest_occurrence",
      "kind": "KPI",
      "id": "21",
      "noteName": "projects/xforce/notes/NumClients",
      "createTime": "2018-02-05T12:56:02.061882Z",
      "context": {
        "region": "US-South",
        "account": "agiammar",
        "resource": "image-1",
        "resourceGroup": "group-efg",
        "service": "cluster-xyz"
      },
      "kpi": {
        "value": 23
      },
      "_year": 2018,
      "_month": 2,
      "_day": 5,
      "_year_week": 6
    },
    {
      "docType": "latest_occurrence",
      "kind": "KPI",
      "id": "21",
      "noteName": "projects/xforce/notes/NumClients",
      "createTime": "2018-02-06T12:56:02.061882Z",
      "context": {
        "region": "US-South",
        "account": "agiammar",
        "resource": "image-2",
        "resourceGroup": "group-efg",
        "service": "cluster-xyz"
      },
      "kpi": {
        "value": 34
      }
    },
    {
      "docType": "occurrence",
      "kind": "KPI",
      "id": "21",
      "noteName": "projects/xforce/notes/NumClients",
      "createTime": "2018-02-05T12:56:02.061882Z",
      "context": {
        "region": "US-South",
        "account": "agiammar",
        "resource": "image-1",
        "resourceGroup": "group-efg",
        "service": "cluster-xyz"
      },
      "kpi": {
        "value": 23
      }
    },
    {
      "docType": "occurrence",
      "kind": "KPI",
      "id": "21",
      "noteName": "projects/xforce/notes/NumClients",
      "createTime": "2018-02-06T12:56:02.061882Z",
      "context": {
        "region": "US-South",
        "account": "agiammar",
        "resource": "image-2",
        "resourceGroup": "group-efg",
        "service": "cluster-xyz"
      },
      "kpi": {
        "value": 34
      }
    },
    {
      "docType": "occurrence",
      "kind": "KPI",
      "id": "21",
      "noteName": "projects/xforce/notes/NumClients",
      "createTime": "2018-02-04T12:56:02.061882Z",
      "context": {
        "region": "US-South",
        "account": "agiammar",
        "resource": "image-1",
        "resourceGroup": "group-efg",
        "service": "cluster-xyz"
      },
      "kpi": {
        "value": 56
      }
    }
  ]
}

MAP:
if (doc.docType == "latestOccurrence" and doc.kind=="KPI")
  emit(["noteName, context.account", "context.resource"], kpi.value]
        REDUCE: _sum


# GET the last occurrence of each UNIQUE resource for the specifid noteName
# SUM all the kpi.value fields
